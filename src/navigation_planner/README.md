# 导航规划器实现详解

## 1. 整体架构

导航规划器模块是自动驾驶数据闭环系统的核心组件之一，负责路径规划和数据采集优化。它集成了多个子模块，形成了一个完整的路径规划和数据采集系统：

- NavPlannerNode：中央协调器，整合所有导航规划组件
- RoutePlanner：路径规划器，支持A*和PPO两种算法
- CostMap：成本地图，根据数据密度动态调整成本
- SamplingOptimizer：采样优化器，优化下一个数据采集点
- SemanticMap：语义地图，处理环境中的语义信息
- CoverageMetric：覆盖率度量，计算各种覆盖率指标

## 2. 核心组件

### 2.1 NavPlannerNode（导航规划节点）

NavPlannerNode 是整个导航规划系统的中枢，负责协调各个组件的工作：

- 初始化所有子模块（成本地图、路径规划器、采样优化器等）
- 加载和管理来自YAML配置文件的参数
- 实现全局和局部路径规划功能
- 验证路径约束
- 更新覆盖率度量
- 计算状态转移奖励
- 支持动态重载配置参数
- 支持PPO权重的加载和保存

### 2.2 RoutePlanner（路径规划器）

RoutePlanner 实现了两种路径规划算法：

- A*算法：经典的寻路算法，用于基础路径规划
- PPO算法：基于强化学习的路径规划算法

路径规划器还实现了基于数据密度统计的成本调整功能：

- 对稀疏区域降低成本（鼓励探索）
- 对高密度区域增加成本（避免冗余）

### 2.3 PPOAgent（PPO代理）

PPOAgent 是强化学习算法的具体实现：

- 实现了简化版的PPO算法
- 包含演员（Actor）和评论家（Critic）神经网络
- 支持动作选择和状态价值计算
- 支持权重的保存和加载

### 2.4 CostMap（成本地图）

CostMap 维护一个二维网格，每个单元格包含成本和数据密度值：

- 根据收集的数据点更新统计数据
- 根据数据密度调整成本
- 支持边界检查以确保安全访问单元格

### 2.5 RewardCalculator（奖励计算器）

RewardCalculator 实现了强化学习的奖励函数：

- 访问新稀疏区域给予+10的奖励
- 成功触发数据采集给予+0.5的奖励
- 发生碰撞给予-1.0的惩罚
- 每步给予-0.01的小惩罚以鼓励短路径
- 可选地基于到最近稀疏单元格的距离提供形状奖励

## 3. 工作流程

- 初始化：NavPlannerNode 初始化所有组件并加载配置参数
- 成本地图更新：使用收集的数据点更新成本地图
- 路径规划：根据算法选择（A*或PPO）进行路径规划
- 路径验证：检查规划的路径是否满足约束条件
- 采样优化：优化下一个数据采集点
- 奖励计算：计算状态转移的奖励
- 覆盖率更新：更新覆盖率度量

## 4. 算法特点

### 4.1 双模式路径规划

系统支持两种路径规划算法的动态切换：

- A*算法：稳定可靠的启发式搜索算法，适合基础应用
- PPO算法：基于强化学习的先进算法，能够适应动态环境并优化长期奖励

### 4.2 数据驱动的成本调整

成本地图会根据历史数据采集模式动态调整：

- 稀疏区域成本降低，鼓励探索
- 高密度区域成本增加，避免冗余采集

### 4.3 强化学习集成

通过PPO算法，系统可以学习到更优的路径规划策略：

- 使用演员-评论家架构
- 支持在线学习和权重更新
- 可以通过奖励函数优化特定目标

## 5. 配置和参数

系统通过YAML配置文件进行配置，主要参数包括：

- `sparse_threshold`：稀疏区域的数据密度阈值
- `exploration_bonus`：对访问稀疏区域的行为给予成本奖励
- `redundancy_penalty`：对高密度区域增加额外成本
- `grid_resolution`：密度计算所用网格分辨率